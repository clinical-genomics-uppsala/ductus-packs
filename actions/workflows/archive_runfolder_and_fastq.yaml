version: "1.0" # mistral version

description: Will archive data runfolders and fastq files

input:
    - runfolder_path
    - runfolder_name
    - project_type
    - storage_path_runfolder
    - fastq_path
    - storage_path_fastq
    - mail_bioinfo

vars:
  - samples: null

tasks:
  get_samples_to_save:
  action: core.local
    input:
      cwd: <% ctx(runfolder_path) %>/<% ctx(runfolder_name) %>/
      cmd: python3 -c 'from ductus.tools.utils import print_samples; print_samples("wp1", <% ctx(project_type) %>, "sera", "<% ctx(samplesheet_file) %>")'
    next:
      - when: <% succeeded() %>
        publish: samples=<% result().stdout %>
        do:
          - fastq_files
      - when: <% failed() %>
        publish: failed_step='get_project_types  -- Couldn't extract samples <% ctx(runfolder_path) %>/<% ctx(runfolder_name) %>/, <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  fastq_files:
    with:
      items: <% ctx(samples) %>
    action: core.local
    input:
      cwd: /opt/src/ductus-core/ductus/scripts
      cmd: python3 rsync.py -c -f "<% ctx(fastq_path) %>/<% item() %>*fastq.gz" -t <% ctx(storage_path_fastq)/ %> -l
      timeout: 86400
    next:
      - when: <% succeeded() %>
        do:
          - compress_runfolder_folder
      - when: <% failed() %>
        publish: failed_step="sync_miseq_fastq_files -- Couldn't archive fastq files <% ctx(fastq_path) %>, <% result().stdout %>, <% result().stderr %>"
        do:
          - bioinfo_error_notifier

  compress_runfolder_folder:
    action: core.local
    input:
      cwd: <% ctx(runfolder_path) %>/
      cmd: tar -zcf --exclude="*.fastq.gz" <% ctx(storage_path_runfolder) %>/<% ctx(runfolder_name) %>.tar.gz <% ctx(runfolder_name) %>
      timeout: 86400
    next:
      - when: <% succeeded() %>
        do:
          - validate_runfolder_archive
      - when: <% failed() %>
        publish: failed_step='compress_runfolder_folder  -- Couldn't compress folder <% ctx(runfolder_path) %>/<% ctx(runfolder_name), <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier

  validate_runfolder_archive:
    action: core.local
    input:
      cmd: tar --compare --file=<% ctx(storage_path_runfolder) %>/<% ctx(runfolder_name) %>.tar.gz -C <% ctx(storage_path_runfolder) %>
      timeout: 86400
    next:
      - when: <% succeeded() %>
        do:
          - create_checksum_for_archive
      - when: <% failed() %>
        publish: failed_step='validate_runfolder_archive  -- Couldn't validate compressed folder <% ctx(archive_runfolder) %>/<% ctx(experiment_name) %>.tar.gz, <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier

  create_checksum_for_archive:
    action: core.local
    input:
      cwd: <% ctx(storage_path_runfolder) %>
      cmd: sha256sum <% ctx(runfolder_name) %>.tar.gz > <% ctx(runfolder_name) %>.tar.gz.sha256
      timeout: 86400
    next:
      - when: <% succeeded() %>
        do:
          - create_archived_folder
      - when: <% failed() %>
        publish: failed_step='create_checksum_for_archive  -- Couldn't create checksum for compressed folder <% ctx(storage_path_runfolder) %>/<% ctx(runfolder_name) %>.tar.gz, <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier

  create_archived_folder:
    action: core.local
    input:
      cwd: <% ctx(runfolder_path) %>
      cmd: mkdir -p archived_runfolders
    next:
      - when: <% succeeded() %>
        do:
          - move_archived_folder
      - when: <% failed() %>
        publish: failed_step='create_archived_folder  -- Couldn't create folder <% ctx(runfolder_path) %>/archived_runfolder, <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier

  move_archived_folder:
    action: core.local
    input:
      cwd: <% ctx(runfolder_path) %>
      cmd: mv <% ctx(runfolder_name) %> archived_runfolders/
    next:
      - when: <% succeeded() %>
        do:
          - archive_done_notifier
      - when: <% failed() %>
        publish: failed_step='create_archived_folder  -- Couldn't create folder <% ctx(runfolder_path) %>/archived_runfolder, <% result().stdout %>, <% result().stderr %>'
        do:
          - bioinfo_error_notifier

  bioinfo_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>
      from: "stanley@clinicalgenomics-as.se"
      subject: "'[DUCTUS][WP][ERROR] - Archiving, <% ctx(runfolder_name) %>'"
      body: Something went wrong during the archiving of <% ctx(runfolder_name) %>, please investigate!!!\n Failure message -- <% ctx(failed_step) %>
    next:
      - when: <% succeeded() %>
        do:
          - fail
