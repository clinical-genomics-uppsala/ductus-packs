version: "1.0" # Orquest version

description: Will process a new sequence run

input:
  - runfolder
  - runfolder_host
  - runfolder_host_port
  - runfolder_api_version
  - demultiplexing_host
  - demultiplexing_host_port
  - demultiplexing_output_folder
  - api_version
  - mail_bioinfo
  - processing_api_service_url
  - processing_api_upload_illumina_run_url
  - processing_api_list_samples_url
  - processing_api_update_fastq_info_url
  - analysis_csv_folder_path
  - converted_samplesheet_folder_path
  - sample_update_json_folder_path

vars:
  - samplesheet_file: null
  - analysis_files: null
  - runinfo_file: null
  - experiments: null
  - fastq_update_file: null
  - runfolder_path: null
  - runfolder_name: null
  - experiments_folder: null
  - failed_step: null
  - samples: null
  - stderr: null
  - machine_name: null

tasks:
  mark_as_atarted:
    action: core.http
    input:
      url: http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(runfolder_api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "started"}'
      method: "POST"
    next:
      - when: <% succeeded() %>
        do:
          - check_for_samplesheet
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: 'mark_as_started_processing -- Could not mark <% ctx(runfolder) %> with processing started'
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  check_for_samplesheet:
    action: core.local
    input:
      cmd: ls <% ctx(runfolder) %>/SampleSheet.csv
    next:
      - when: <% succeeded() %>
        publish: samplesheet_file=<% result().stdout %>
        do:
          - check_for_runinfo
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "check_for_samplesheet  -- Couldn't locate a SampleSheet.csv file in folder <% ctx(runfolder) %>, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  check_for_runinfo:
    action: core.local
    input:
      cmd: ls <% ctx(runfolder) %>/RunInfo.xml
    next:
      - when: <% succeeded() %>
        publish: runinfo_file=<% result().stdout %>
        do:
          - dos2unix
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "check_for_runinfo  -- Couldn't locate a RunInfo.xml file in folder <% ctx(runfolder) %>, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  dos2unix:
    action: core.local
    input:
      cwd: <% ctx(runfolder) %>
      cmd: mv <% ctx(samplesheet_file)%> <% ctx(samplesheet_file)%>.copy && dos2unix -n <% ctx(samplesheet_file)%>.copy <% ctx(samplesheet_file)%>
    next:
      - when: <% succeeded %>
        do:
          - get_runfolder_name
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "dos2unix -- Could not run dos2unix on ctx(samplesheet_file)%>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed
  
  get_runfolder_name:
    action: core.local
    input:
      cmd: basename <% ctx(runfolder) %>
    next:
      - when: <% succeeded() %>
        publish: runfolder_name=<% result().stdout %>
        do:
          - detect_old_samplesheet_format
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_runfolder_name  -- Couldn't get runfolder name, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  detect_old_samplesheet_format:
    action: core.local
    input:
      cwd:  <% ctx(runfolder) %>
      cmd: python3 -c 'from ductus.tools.utils import is_old_ductus_format; exit(0) if is_old_ductus_format("<% ctx(samplesheet_file) %>") == 1 else exit(1)'
    next:
      - when: <% succeeded() %>
        do:
          - create_analysis_file
      - when: <% failed() %>
        do:
          - upload_sequencerun

  create_analysis_file:
    action: core.local
    input:
      cmd: python3 -c 'from ductus.tools.utils import create_analysis_file; import json; print(json.dumps(create_analysis_file("<% ctx(samplesheet_file)%>", "<% ctx(analysis_csv_folder_path)%>")))'
    next:
      - when: <% succeeded() %>
        publish: analysis_files=<% result().stdout %>
        do:
          #- upload_analysis
          - convert_old_samplesheet_to_new
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_analysis_file --Couldn't create an analysis file from ctx(samplesheet_file)%>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  # upload_analysis:
  #   with:
  #     items: <% ctx(analysis_files) %>
  #     concurrency: 1
  #   action: core.local
  #   input:
  #     cmd: sh -c 'status=$(curl -o /dev/null -s --write-out "%{http_code}" -X POST -F "analysis=@<% item() %>" <% ctx(processing_api_service_url) %>/api/analysis/upload/); echo $status; [ $status -eq "201" ]'
  #   next:
  #     - when: <% succeeded() %>
  #       do:
  #         - convert_old_samplesheet_to_new
  #     - when: <% failed() %>
  #       publish:
  #         - stderr: <% result().stderr %>
  #         - failed_step: "upload_analyis -- Couldnt upload analysis <% ctx(runfolder_name) %> to processing api"
  #       do:
  #         - bioinfo_error_notifier
  #         - mark_as_failed

  convert_old_samplesheet_to_new:
    action: core.local
    input:
      cmd: python3 -c 'from ductus.tools.utils import convert_old_cgu_samplesheet_format_to_new; convert_old_cgu_samplesheet_format_to_new("<% ctx(samplesheet_file)%>", "<% ctx(converted_samplesheet_folder_path)%>/<% ctx(runfolder_name)%>_samplesheeet.csv")'
    next:
      - when: <% succeeded() %>
        publish: samplesheet_file="<% ctx(converted_samplesheet_folder_path)%>/<% ctx(runfolder_name)%>_samplesheeet.csv"
        do:
          - upload_sequencerun
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "convert_old_samplesheet_to_new -- Couldn't convert old samplesheet to new format: ctx(samplesheet_file)%>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  upload_sequencerun:
    join: 1
    action: core.local
    input:
      cmd: sh -c 'status=$(curl -o /dev/null -s --write-out "%{http_code}" -X POST -F "samplesheet=@<% ctx(samplesheet_file) %>" -F "runinfo=@<% ctx(runinfo_file) %>" <% ctx(processing_api_service_url) %>/<% ctx(processing_api_upload_illumina_run_url) %>); echo $status; [ $status -eq "201" ]'
    next:
      - when: <% succeeded() %>
        do:
          - get_samples
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "upload_sequencerun -- Couldnt upload sequencerun <% ctx(runfolder_name) %> to processing api"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  get_samples:
    action: core.local
    input:
       cmd: curl <% ctx(processing_api_service_url) %>/<% ctx(processing_api_list_samples_url) %>?sequencing_run__run_id=<% ctx(runfolder_name) %> | python3 -c 'import json; import sys; print(json.dumps([(sample["sample_id"], sample["experiment_id"]) for sample in json.load(sys.stdin)]))'
    next:
      - when: <% succeeded %>
        publish: samples=<% result().stdout %>
        do:
          - create_fastq_update_query
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_samples -- Could not fetch samples for <% ctx(runfolder_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_fastq_update_query:
    join: 1
    action: core.local
    input:
      cmd:  echo "<% ctx(samples) %>" | sed 's/\x27/"/g' | python3 -c 'from ductus.tools.utils import create_json_update_fastq, combine_files_with_samples; import sys, json, glob; print(json.dumps(create_json_update_fastq(combine_files_with_samples(json.loads(sys.stdin.read()), glob.glob("<% ctx(runfolder) %>/**/*.fastq.gz", recursive=True)))))' > <% ctx(sample_update_json_folder_path)%>/<% ctx(runfolder_name)%>_update.json
    next:
      - when: <% succeeded %>
        publish: fastq_update_file="<% ctx(sample_update_json_folder_path)%>/<% ctx(runfolder_name)%>_update.json"
        do:
          - add_fastq_information
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_fastq_update_query -- Could not create update query for <% ctx(runfolder_name) %> to update fastq information"
        do:
          - bioinfo_error_notifier
          - mark_as_failed
    
  add_fastq_information:
    action: core.local
    input:
      cmd: sh -c 'status=$(curl -o /dev/null -s --write-out "%{http_code}"  -X POST -F "update_json=@<% ctx(fastq_update_file) %>" <% ctx(processing_api_service_url) %>/<% ctx(processing_api_update_fastq_info_url) %>); echo $status; [ $status -eq "201" ]'
    next:
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "add_fastq_information -- Could not add fastq information to processing api for <% ctx(runfolder_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  bioinfo_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>
      from: stanley@clinicalgenomics-as.se
      subject: "[DUCTUS][WP][ERROR] - Pre-processing, <% ctx(runfolder_name) %>"
      body: Something went wrong during the population of the processing api with <% ctx(runfolder_name) %>, please investigate!!!\n Failure message -- <% ctx(failed_step) %>, <% ctx(stderr) %>
    next:
      - do:
          - fail

  mark_as_failed:
    action: core.http
    input:
      url:  http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "error"}'
      method: "POST"
    next:
      - when: <% succeeded() %>
        do:
          - fail

output:
  - stderr: <% ctx(stderr) %>
