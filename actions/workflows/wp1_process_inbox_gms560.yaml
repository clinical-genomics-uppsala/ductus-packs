version: "1.0" # Orquesta version
description: Will analyse data found in the inbox folder using GMS560

input:
  - runfolder
  - runfolder_host
  - runfolder_host_port
  - runfolder_api_version
  - local_folder_prefix
  - project_type
  - processing_host
  - processing_key
  - processing_user
  - gms560_git_url
  - gms560_version
  - mail_lab
  - mail_bioinfo

vars:
  - experiment_name: null
  - run_year: null
  - analysis_folder: null
  - projects_analysis_folder: null
  - outbox_folder: null
  - stderr: null

tasks:
  get_experiment_name:
    action: core.local
    input:
      cmd: python3 -c 'import sys; sys.stdout.write("<% ctx(runfolder) %>".split("/")[-1])'
    next:
      - when: <% succeeded() %>
        publish: experiment_name=<% result().stdout %>
        do:
          - get_run_year
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: 'get_experiment_name  -- Could not get experiment name'
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  get_run_year:
    action: core.local
    input:
      cmd: python3 -c 'import sys;import re; p = re.compile("^(\d{4})\d{4}_[a-zA-Z-]{2,}");sys.stdout.write(p.search("<% ctx(experiment_name) %>").group(1))'
    next:
      - when: <% succeeded() %>
        publish: run_year=<% result().stdout %>
        do:
          - create_analysis_folder
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: 'get_run_year  -- Could not extract run year from <% ctx(experiment_name) %>'
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_analysis_folder:
    action: core.local
    input:
      cmd: mkdir -p /scratch/wp1/nobackup/ngs/<% ctx(project_type) %>/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>
      cwd: <% ctx(runfolder) %>
    next:
      - when: <% succeeded() %>
        publish: analysis_folder="/scratch/wp1/nobackup/ngs/<% ctx(project_type) %>/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>"
        do:
          - mark_as_started
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_analysis_folder  -- Could not create analysis folder: /scratch/wp1/nobackup/ngs/klinik/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  mark_as_started:
    action: core.http
    input:
      url: http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(runfolder_api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "started"}'
      method: "POST"
    next:
      - when: <% succeeded() %>
        do:
          - clone_gms560_repo
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "mark_as_started -- Could not mark <% ctx(runfolder) %> as started!"
        do:
          - bioinfo_error_notifier

  clone_gms560_repo:
    action: core.local
    input:
      cmd: git clone --depth 1 --branch <% ctx(gms560_version) %> <% ctx(gms560_git_url) %>  <% ctx(analysis_folder) %>
      timeout: 300
    next:
      - when: <% succeeded() %>
        do:
          - sync_data
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "clone_gms560_repo  -- Could not clone repo <% ctx(gms560_git_url) %>, <% ctx(gms560_version) %> into <% ctx(analysis_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  sync_data:
    action: core.local
    input:
      cwd: <% ctx(runfolder) %>
      cmd: rsync -Prv SampleSheet.csv fastq <% ctx(analysis_folder) %>/
      timeout: 3600
    next:
      - when: <% succeeded() %>
        do:
         - create_sample_unit_file
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "sync_data  -- Could not sync SampleSheet.csv"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_sample_unit_file:
    action: core.remote
    input:
      username: <% ctx(processing_user) %>
      private_key: <% ctx(processing_key) %>
      hosts: <% ctx(processing_host) %>
      cwd: <% ctx(analysis_folder) %>
      cmd: bash /projects/wp1/nobackup/GMS560/Bin/create_sample_unit_file_GMS560.sh
      timeout: 172800
      hosts: <% ctx(processing_host) %>
    next:
      - when: <% succeeded() %>
        do:
          - modify_sample_unit_file
      - when: <% failed() %>
        publish:
          - stderr: "Creation if sample.tsv and units.tsv failed"
          - failed_step: "create_sample_unit_file -- failed creation if sample.tsv and units.tsv on  <% ctx(analysis_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  modify_sample_unit_file:
    action: core.remote
    input:
      username: <% ctx(processing_user) %>
      private_key: <% ctx(processing_key) %>
      hosts: <% ctx(processing_host) %>
      cwd: <% ctx(analysis_folder) %>
      cmd: bash /projects/wp1/nobackup/GMS560/Bin/modify_sample_unit_file_GMS560.sh
      timeout: 172800
      hosts: <% ctx(processing_host) %>
    next:
      - when: <% succeeded() %>
        do:
          - run_gms560_analysis
      - when: <% failed() %>
        publish:
          - stderr: "Modifying sample.tsv and units.tsv failed"
          - failed_step: "modify_sample_unit_file -- failed modifying if sample.tsv and units.tsv on  <% ctx(analysis_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  run_gms560_analysis:
    action: core.remote
    input:
      username: <% ctx(processing_user) %>
      private_key: <% ctx(processing_key) %>
      hosts: <% ctx(processing_host) %>
      cwd: <% ctx(analysis_folder) %>
      cmd: bash /projects/wp1/nobackup/GMS560/Bin/start_pipeline_marvin_GMS560.sh
      timeout: 172800
      hosts: <% ctx(processing_host) %>
    next:
      - when: <% succeeded() %>
        do:
          - create_OUTBOX_gms560_analysis
      - when: <% failed() %>
        publish:
          - stderr: "gms560 analysis failed"
          - failed_step: "run_gms560_analysis  -- failed running GMS560 analysis on  <% ctx(analysis_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_OUTBOX_gms560_analysis:
    action: core.local
    input:
      cmd: mkdir -p <% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/OUTBOX/<% ctx(experiment_name) %>
    next:
      - when: <% succeeded() %>
        publish: outbox_folder="<% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/OUTBOX/<% ctx(experiment_name) %>"
        do:
          - create_project_analysis_gms560
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_OUTBOX_gms560_analysis  -- Could not outbox folder <% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/OUTBOX/<% ctx(experiment_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_project_analysis_gms560:
    action: core.local
    input:
      cmd: mkdir -p <% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>
    next:
      - when: <% succeeded() %>
        publish: projects_analysis_folder="<% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>"
        do:
          - sync_result_to_outbox
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_project_analysis_gms560 -- Could not project analys folder <% ctx(local_folder_prefix) %>/ngs/<% ctx(project_type) %>/analys/<% ctx(run_year) %>/<% ctx(experiment_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  sync_result_to_outbox:
      action: core.local
      input:
        cmd: rsync -Prv bam_*na results <% ctx(outbox_folder) %>/
        cwd: <% ctx(analysis_folder) %>
        timeout: 7200
      next:
        - when: <% succeeded() %>
          do:
            - create_Done_txt
            - sync_analysis_to_project
        - when: <% failed() %>
          publish:
            - stderr: <% result().stderr %>
            - failed_step: "sync_result_to_outbox  -- Could not sync bam_dna, bam_rna, results, to <% ctx(outbox_folder) %>"
          do:
            - bioinfo_error_notifier
            - mark_as_failed

  sync_analysis_to_project:
    action: core.local
    input:
      cmd: rsync -Prv <% ctx(analysis_folder) %>/* <% ctx(projects_analysis_folder) %>
      timeout: 7200
    next:
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "sync_analysis_to_project  -- Could not sync analysis files to <% ctx(projects_analysis_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  create_Done_txt:
    action: core.local
    input:
        cmd: echo "`date`" > <% ctx(outbox_folder) %>/Done.txt;
    next:
      - when: <% succeeded() %>
        do:
          - mark_as_finished
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "create_Done_txt  -- Could not create Done.txt in  <% ctx(outbox_folder) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  bioinfo_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>
      from: stanley@clinicalgenomics-uu.se
      subject: "[DUCTUS][WP1][ERROR] - GMS560 processing, <% ctx(experiment_name) %>"
      body: Something went wrong during the GMS560 processing of <% ctx(experiment_name) %>, please investigate!!!\n Failure message -- <% ctx(failed_step)  %>, <% ctx(stderr) %>
    next:
      - when: <% succeeded() %>
        do:
          - fail

  mark_as_finished:
    action: core.http
    input:
      url: http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(runfolder_api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "done"}'
      method: "POST"

  mark_as_failed:
    action: core.http
    input:
      url:  http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(runfolder_api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "error"}'
      method: "POST"
    next:
      - when: <% succeeded() %>
        do:
          - fail
          - molpat_error_notifier

  molpat_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_lab) %>
      from: stanley@clinicalgenomics-uu.se
      subject: "[DUCTUS][WP1][ERROR] - GMS560 processing failure, <% ctx(experiment_name) %>"
      body: Something went wrong during GMS560 processing of folder <% ctx(experiment_name) %>. A Bioinformatician has been notified.
    next:
      - when: <% succeeded() %>
        do:
          - fail

output:
  - stderr: <% ctx(stderr) %>
