version: "1.0" # Orquest version

description: Will look for new analysis files and upload them

input:
    - analysis_csv_folder_path
    - processing_api_service_url
    - processing_api_upload_analysis_url

vars:
  - failed_step: null
  - analysis_files: null
  - stderr: "ERROR"

tasks:
  find_analysis_files:
    action: core.local
    input:
      cwd:  <% ctx(analysis_csv_folder_path) %>
      cmd: ls *_analysis.csv
    next:
      - when: <% succeeded() %>
        publish: analysis_files=<% result().stdout %>
        do:
          - upload_analysis_files
      - when: <% failed() %>
        do:
          - no_files_found

  no_files_found:
    action: core.noop

  upload_analysis_files:
    with:
      items: <% ctx(analysis_csv_folder_path) %>
      concurrency: 1
    action: core.local
    input:
      cwd: <% ctx(analysis_csv_folder_path) %>
      cmd: curl -X POST -F "analysis=@<% item() %>" <% ctx(processing_api_service_url) %><% ctx(processing_api_upload_analysis_url) %>
    next:
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "upload_analysis_files -- failed when uploading one of  <% ctx(analysis_csv_folder_path) %>"
        do:
         - bioinfo_error_notifier 

  bioinfo_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>
      from: stanley@clinicalgenomics-uu.se
      subject: "[DUCTUS][ERROR] - Failed processing <% ctx(runfolder) %>"
      body: Something went wrong during processing of folder <% ctx(runfolder) %>. A Bioinformatician has been notified.
    next:
      - when: <% succeeded() %>
        do:
          - fail

# output:
#   - stderr: <% ctx(stderr) %>
