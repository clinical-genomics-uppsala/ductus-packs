version: "1.0" # Orquest version

description: Will process data written to Workarea by Illumina machines

input:
  - runfolder
  - runfolder_host
  - runfolder_host_port
  - demultiplexing_host
  - demultiplexing_host_port
  - demultiplexing_output_folder
  - api_version
  - mail_bioinfo
  - check_demultiplexing_completed_delay
  - num_check_demultiplexing_completed
  - check_demultiplexing_retry_delay
  - path_fastq_and_complete_file
  - transfer_to_host
  - transfer_key
  - transfer_user

vars:
  - samplesheet_file: null
  - experiments: null
  - runfolder_path: null
  - runfolder_name: null
  - experiments_folder: null
  - failed_step: null
  - stderr: null
  - machine_name: null

tasks:
  check_for_samplesheet:
    action: core.local
    input:
      cmd: ls SampleSheet.csv
      cwd: <% ctx(runfolder) %>
    next:
      - when: <% succeeded() %>
        publish: samplesheet_file=<% result().stdout %>
        do:
          - dos2unix
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "check_for_samplesheet  -- Couldn't locate a SampleSheet.csv file in folder <% ctx(runfolder) %>, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  dos2unix:
    action: core.local
    input:
      cwd: <% ctx(runfolder) %>
      cmd: mv <% ctx(samplesheet_file)%> <% ctx(samplesheet_file)%>.copy && dos2unix -n <% ctx(samplesheet_file)%>.copy <% ctx(samplesheet_file)%>
    next:
      - when: <% succeeded %>
        do:
          - get_runfolder_name
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "dos2unix -- Could not run dos2unix on ctx(samplesheet_file)%>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  get_runfolder_name:
    action: core.local
    input:
      cmd: basename <% ctx(runfolder) %>
    next:
      - when: <% succeeded() %>
        publish: runfolder_name=<% result().stdout %>
        do:
          - get_runfolder_path
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_runfolder_name  -- Couldn't get runfolder name, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  get_runfolder_path:
    action: core.local
    input:
      cmd: dirname <% ctx(runfolder) %>
    next:
      - when: <% succeeded() %>
        publish: runfolder_path=<% result().stdout %>
        do:
          - get_machine_name
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_runfolder_name  -- Couldn't get dir name for <% ctx(runfolder) %>, <% result().stdout %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  get_machine_name:
    action: core.local
    input:
      cmd: python3 -c 'import sys;import re; p = re.compile("\d{6}_([A-Z]+[0-9]+)_.+");sys.stdout.write(p.search("<% ctx(runfolder_name) %>").group(1))'
    next:
      - when: <% succeeded() %>
        publish:
          - machine_name: "<% result().stdout %>"
          - complete_job_file_path: "<% ctx(runfolder) %>/<% ctx(path_fastq_and_complete_file).where($.name=result().stdout).complete_job_file_path.first() %>"
          - fastq_files_path: "<% ctx(runfolder) %>/<% ctx(path_fastq_and_complete_file).where($.name=result().stdout).fastq_files_path.first() %>"
        do:
          - get_experiments
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_machine_name  -- Couldn't retrieve machine config for runfolder, <% ctx(runfolder_name) %>"
        do:
          - bioinfo_error_notifier
          - unexpected_machine
          - mark_as_failed
  
  get_experiments:
    action: core.local
    input:
      cwd:  <% ctx(runfolder) %>
      cmd: python3 -c 'from ductus.tools.utils import get_experiments; import json; print(json.dumps([experiment for experiment in get_experiments("<% ctx(samplesheet_file) %>")]))'
    next:
      - when: <% succeeded() %>
        publish: experiments=<% result().stdout %>
        do:
          - transfer_data_to_compute
      - when: <% failed() %>
        publish:
          - stderr: <% result().stderr %>
          - failed_step: "get_experiments  -- couldn't fetch experiment information from <% ctx(samplesheet_file) %> in <% ctx(runfolder_name) %>"
        do:
          - bioinfo_error_notifier
          - mark_as_failed

  transfer_data_to_compute:
    with:
      items: <% ctx(experiments) %>
      concurrency: 2
    action: ductus.sync_data
    input:
      transfer_to_host: <% ctx(transfer_to_host) %>
      transfer_user: <% ctx(transfer_user) %>
      transfer_key: <% ctx(transfer_key) %>
      samplesheet_file: <% ctx(samplesheet_file) %>
      fastq_files_path: "<% ctx(fastq_files_path) %>"
      runfolder: <% ctx(runfolder) %>
      experiment_name: <% item() %>
      mail_bioinfo: <% ctx(mail_bioinfo) %>
  #   next:
  #     - when: <% succeeded() %>
  #       publish: experiments=<% result().stdout %>
  #       do:
  #         - transfer_data_to_compute
  #     - when: <% failed() %>
  #       publish:
  #         - stderr: <% result().stderr %>
  #         - failed_step: "get_experiments  -- couldn't fetch experiment information from <% ctx(samplesheet_file) %> in <% ctx(runfolder_name) %>"
  #       do:
  #         - bioinfo_error_notifier
  #         - unexpected_machine
  #         - mark_as_failed
      

  # runfolder_found:
  #   action: core.sendmail
  #   input:
  #     to: <% ctx(mail_bioinfo) %>
  #     from: stanley@clinicalgenomics-as.se
  #     subject: "[DUCTUS][WP] - Pre-processing, <% ctx(runfolder_name) %>, <% ctx(experiments) %>"
  #     body: Found runfolder!

  unexpected_machine:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>"
      from: stanley@clinicalgenomics-as.se
      subject: "[DUCTUS][WP][ERROR] - Incorrect machine typ <% ctx(runfolder_name) %>"
      body: Couldn't parse the machine type from the runfolder name, <% ctx(runfolder_name) %>. New machine or have the folder name been changed?
    next:
      - when: <% succeeded() %>
        do:
          - fail

  # completed_job_file_missing:
  #   action: core.sendmail
  #   input:
  #     to: <% ctx(mail_bioinfo) %>
  #     from: stanley@clinicalgenomics-as.se
  #     subject: "[DUCTUS][WP][ERROR] -  <% ctx(runfolder_name) %>"
  #     body: Couldn't find CompletedJobInfo.xml for <% ctx(runfolder_name) %>
  #   next:
  #     - when: <% succeeded() %>
  #       do:
  #         - fail

  bioinfo_error_notifier:
    action: core.sendmail
    input:
      to: <% ctx(mail_bioinfo) %>
      from: stanley@clinicalgenomics-as.se
      subject: "[DUCTUS][WP][ERROR] - Pre-processing, <% ctx(runfolder_name) %>"
      body: Something went wrong during the pre-processing of <% ctx(runfolder_name) %>, please investigate!!!\n Failure message -- <% ctx(failed_step) %>, <% ctx(stderr) %>
    next:
      - do:
          - fail

  mark_as_failed:
    action: core.http
    input:
      url:  http://<% ctx(runfolder_host) %>:<% ctx(runfolder_host_port) %>/api/<% ctx(api_version) %>/runfolders/path<% ctx(runfolder) %>
      body: '{"state": "error"}'
      method: "POST"
    next:
      - when: <% succeeded() %>
        do:
          - fail

output:
  - stderr: <% ctx(stderr) %>
